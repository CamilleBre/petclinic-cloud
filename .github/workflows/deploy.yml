# CI/CD PetClinic => Build et push sur ECR

name: Petclinic > CI/CD > Github Actions
# mise en place du Trigger
on:
  # Push ou Pull Request sur @camille
  push:
    branches: [ master ] 
  #pull_request:
  #  branches: [ camille ]

env : 
  REPOSITORY_PREFIX : 885801475464.dkr.ecr.eu-west-3.amazonaws.com/ecr-petclinic


# lancement des Jobs
jobs:
  build:
    # Configuration de l'environnement
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java: [ '17' ]
    steps:
    - uses: actions/checkout@v3
    - name: Run a one-line script
      run: echo "build DOCKER images!"

  # Build des images avec maven
    - name: Build images with maven
      run: |
        mvn spring-boot:build-image -Pk8s -DREPOSITORY_PREFIX=${REPOSITORY_PREFIX}
    

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: eu-west-3
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    - name: Push docker images
      run: |
        docker push $REPOSITORY_PREFIX/spring-petclinic-cloud-api-gateway:latest
        docker push $REPOSITORY_PREFIX/spring-petclinic-cloud-visits-service:latest
        docker push $REPOSITORY_PREFIX/spring-petclinic-cloud-vets-service:latest
        docker push $REPOSITORY_PREFIX/spring-petclinic-cloud-customers-service:latest
        docker push $REPOSITORY_PREFIX/spring-petclinic-cloud-admin-server:latest
        docker push $REPOSITORY_PREFIX/spring-petclinic-cloud-discovery-service:latest
        docker push $REPOSITORY_PREFIX/spring-petclinic-cloud-config-server:latest

  deploy-to-eks:
    name: "Build and Push to EKS"
    runs-on: ubuntu-latest
    
    steps:
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: eu-west-3


    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1


    - name: Update kube config
      run: |
        aws eks update-kubeconfig --name eks-petclinic

    # Deploy the YAML files from the kubernetes folder
    - name: Deploy Kubernetes resources
      run: | 

        kubectl apply -f https://raw.githubusercontent.com/CamilleBre/petclinic-cloud/camille/k8s/init-namespace/01-namespace.yaml
        
        #kubectl apply -f https://raw.githubusercontent.com/CamilleBre/petclinic-cloud/camille/k8s/secret.yaml

        #kubectl apply -f https://raw.githubusercontent.com/CamilleBre/petclinic-cloud/camille/k8s/api-gateway-deployment.yaml
        #kubectl apply -f https://raw.githubusercontent.com/CamilleBre/petclinic-cloud/camille/k8s/customers-service-deployment.yaml
        #kubectl apply -f https://raw.githubusercontent.com/CamilleBre/petclinic-cloud/camille/k8s/vets-service-deployment.yaml
        #kubectl apply -f https://raw.githubusercontent.com/CamilleBre/petclinic-cloud/camille/k8s/visits-service-deployment.yaml                         
        kubectl apply -f https://raw.githubusercontent.com/CamilleBre/petclinic-cloud/camille/k8s/init-services/02-config-map.yaml
        kubectl apply -f https://raw.githubusercontent.com/CamilleBre/petclinic-cloud/camille/k8s/init-services/02-system-config-map.yaml
        kubectl apply -f https://raw.githubusercontent.com/CamilleBre/petclinic-cloud/camille/k8s/init-services/03-role.yaml
        #kubectl apply -f https://raw.githubusercontent.com/CamilleBre/petclinic-cloud/camille/k8s/init-services/04-wavefront.yaml
        kubectl apply -f https://raw.githubusercontent.com/CamilleBre/petclinic-cloud/camille/k8s/init-services/05-api-gateway-service.yaml
        kubectl apply -f https://raw.githubusercontent.com/CamilleBre/petclinic-cloud/camille/k8s/init-services/06-customers-service-service.yaml
        kubectl apply -f https://raw.githubusercontent.com/CamilleBre/petclinic-cloud/camille/k8s/init-services/07-vets-service-service.yaml
        kubectl apply -f https://raw.githubusercontent.com/CamilleBre/petclinic-cloud/camille/k8s/init-services/08-visits-service-service.yaml
        
        
      #kubectl apply --recursive -f https://github.com/CamilleBre/petclinic-cloud/tree/camille/k8s/